# ì–´ì œ ê¸°ì˜¨ vs ì—­ëŒ€ ê¸°ì˜¨  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (c) 2025 Example â€“ ìžìœ ë¡­ê²Œ ìˆ˜ì •Â·ìž¬ë°°í¬ ê°€ëŠ¥
# ---------------------------------------------------------------

import streamlit as st
import pandas as pd
import datetime
import os
import plotly.express as px
#import koreanize_matplotlib   # í•œê¸€ í°íŠ¸ ìžë™ ì„¤ì • (ê·¸ëž˜í”„Â·í‘œì‹œìš©)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. íŽ˜ì´ì§€ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="ì–´ì œ ê¸°ì˜¨ vs ì—­ëŒ€ ê¸°ì˜¨",
    layout="centered",
    page_icon="ðŸ“ˆ",
)
st.title("ðŸ“ˆ ì–´ì œëŠ” ì–¼ë§ˆë‚˜ ë”ì› ì„ê¹Œ?")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ë°ì´í„° ë¡œë”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def load_temperature_csv(path_or_file, skiprows: int = 7) -> pd.DataFrame:
    """CP949 â†’ UTF-8-SIG ìˆœìœ¼ë¡œ ì‹œë„í•˜ì—¬ CSV ë¡œë“œ"""
    for enc in ("cp949", "utf-8-sig"):
        try:
            df = pd.read_csv(path_or_file, encoding=enc, skiprows=skiprows)
            break
        except UnicodeDecodeError:
            continue
    else:
        raise ValueError("ì§€ì›ë˜ì§€ ì•ŠëŠ” ì¸ì½”ë”©ìž…ë‹ˆë‹¤.")

    # ë‚ ì§œ ì „ì²˜ë¦¬
    if "ë‚ ì§œ" not in df.columns:
        raise ValueError("CSVì— 'ë‚ ì§œ' ì—´ì´ ì—†ìŠµë‹ˆë‹¤.")
    df["ë‚ ì§œ"] = pd.to_datetime(df["ë‚ ì§œ"].astype(str).str.strip(), format="%Y-%m-%d")
    return df


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. CSV ì—…ë¡œë“œ ë˜ëŠ” ê¸°ë³¸ íŒŒì¼ ì‚¬ìš©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
uploaded_file = st.file_uploader(
    "CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (CP949 ë˜ëŠ” UTF-8, 7í–‰ í—¤ë” ì œì™¸)",
    type="csv",
)

if uploaded_file is None:
    # ì—…ë¡œë“œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒì¼ ì°¾ê¸°
    default_file = next(
        (fname for fname in os.listdir(".") if fname.startswith("ta") and fname.endswith(".csv")),
        None,
    )
    if default_file:
        uploaded_file = default_file
        st.info(f"ê¸°ë³¸ íŒŒì¼ **{default_file}** ì„(ë¥¼) ì‚¬ìš©í•©ë‹ˆë‹¤.")
    else:
        st.warning("CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ìž‘ì—… í´ë”ì— 'ta*.csv' íŒŒì¼ì„ ë‘ì„¸ìš”.")
        st.stop()

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
try:
    df = load_temperature_csv(uploaded_file)
except Exception as e:
    st.error(f"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ë¶„ì„ ëŒ€ìƒ ë‚ ì§œ(ì–´ì œ) ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
today      = datetime.date.today()
yesterday  = today - datetime.timedelta(days=1)
yesterday_dt = pd.to_datetime(yesterday)

st.subheader(f"ðŸ” ë¶„ì„ ëŒ€ìƒ ë‚ ì§œ: {yesterday:%Y-%m-%d}")

df_yest = df[df["ë‚ ì§œ"] == yesterday_dt]
if df_yest.empty:
    st.warning("ë°ì´í„°ì— ì–´ì œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. CSVë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. ì—°ë„ ë²”ìœ„ ìŠ¬ë¼ì´ë”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
year_min, year_max = df["ë‚ ì§œ"].dt.year.min(), df["ë‚ ì§œ"].dt.year.max()
sel_years = st.slider(
    "ë¹„êµí•  ì—°ë„ ë²”ìœ„",
    min_value=int(year_min),
    max_value=int(year_max),
    value=(int(year_min), int(year_max)),
)

# ì–´ì œì™€ ê°™ì€ MM-DDë¥¼ ê°€ì§„ í–‰ë§Œ ì¶”ì¶œ
same_day_df = df[
    (df["ë‚ ì§œ"].dt.strftime("%m-%d") == yesterday.strftime("%m-%d"))
    & (df["ë‚ ì§œ"].dt.year.between(*sel_years))
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. ìµœê³ Â·ìµœì € ê¸°ì˜¨ ëž­í‚¹ ê³„ì‚°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
high_temp = df_yest["ìµœê³ ê¸°ì˜¨(â„ƒ)"].iloc[0]
low_temp  = df_yest["ìµœì €ê¸°ì˜¨(â„ƒ)"].iloc[0]

rank_high_df = same_day_df.sort_values("ìµœê³ ê¸°ì˜¨(â„ƒ)", ascending=False).reset_index(drop=True)
rank_low_df  = same_day_df.sort_values("ìµœì €ê¸°ì˜¨(â„ƒ)").reset_index(drop=True)

rank_high = rank_high_df[rank_high_df["ë‚ ì§œ"] == yesterday_dt].index[0] + 1  # 1-based
rank_low  = rank_low_df[rank_low_df["ë‚ ì§œ"] == yesterday_dt].index[0] + 1

pct_high = 100 * (rank_high - 1) / len(rank_high_df)  # 1ìœ„ê°€ 0 %
pct_low  = 100 * (rank_low  - 1) / len(rank_low_df)

rec_high = rank_high_df.iloc[0]
rec_low  = rank_low_df.iloc[0]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7. ê²°ê³¼ í‘œì‹œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("### ðŸ† ì—­ëŒ€ ê¸°ë¡ ìš”ì•½")
st.write(
    f"ðŸ“ˆ **ì—­ëŒ€ ìµœê³ ê¸°ì˜¨**: {rec_high['ìµœê³ ê¸°ì˜¨(â„ƒ)']}â„ƒ "
    f"({rec_high['ë‚ ì§œ'].date()}) â†’ ì–´ì œë³´ë‹¤ "
    f"{rec_high['ìµœê³ ê¸°ì˜¨(â„ƒ)'] - high_temp:+.1f}â„ƒ"
)
st.write(
    f"â„ï¸ **ì—­ëŒ€ ìµœì €ê¸°ì˜¨**: {rec_low['ìµœì €ê¸°ì˜¨(â„ƒ)']}â„ƒ "
    f"({rec_low['ë‚ ì§œ'].date()}) â†’ ì–´ì œë³´ë‹¤ "
    f"{rec_low['ìµœì €ê¸°ì˜¨(â„ƒ)'] - low_temp:+.1f}â„ƒ"
)

c1, c2 = st.columns(2)
c1.metric("ðŸŒ¡ï¸ ì–´ì œ ìµœê³ ê¸°ì˜¨", f"{high_temp}â„ƒ", f"ìƒìœ„ {pct_high:.1f}%")
c2.metric("ðŸŒ™ ì–´ì œ ìµœì €ê¸°ì˜¨", f"{low_temp}â„ƒ",  f"ìƒìœ„ {pct_low:.1f}%")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8. Top 5 í…Œì´ë¸” & ì¶”ì´ ê·¸ëž˜í”„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
st.subheader("ðŸ”¥ ì—­ëŒ€ ë™ì¼ ë‚ ì§œ ì¤‘ ê°€ìž¥ ë”ì› ë˜ ë‚  Top 5")
st.dataframe(rank_high_df.head(5).reset_index(drop=True))

fig_high = px.line(
    same_day_df.sort_values("ë‚ ì§œ"),
    x="ë‚ ì§œ", y="ìµœê³ ê¸°ì˜¨(â„ƒ)",
    title=f"ì—­ëŒ€ {yesterday:%mì›” %dì¼} ìµœê³ ê¸°ì˜¨ ì¶”ì´",
)
fig_high.add_scatter(
    x=[yesterday_dt], y=[high_temp],
    mode="markers+text",
    name="ì–´ì œ", marker=dict(size=12, color="red"),
    text=["ì–´ì œ"], textposition="top center",
)
st.plotly_chart(fig_high, use_container_width=True)

st.markdown("---")
st.subheader("â„ï¸ ì—­ëŒ€ ë™ì¼ ë‚ ì§œ ì¤‘ ê°€ìž¥ ì¶”ì› ë˜ ë‚  Top 5")
st.dataframe(rank_low_df.head(5).reset_index(drop=True))

fig_low = px.line(
    same_day_df.sort_values("ë‚ ì§œ"),
    x="ë‚ ì§œ", y="ìµœì €ê¸°ì˜¨(â„ƒ)",
    title=f"ì—­ëŒ€ {yesterday:%mì›” %dì¼} ìµœì €ê¸°ì˜¨ ì¶”ì´",
)
fig_low.add_scatter(
    x=[yesterday_dt], y=[low_temp],
    mode="markers+text",
    name="ì–´ì œ", marker=dict(size=12, color="blue"),
    text=["ì–´ì œ"], textposition="top center",
)
st.plotly_chart(fig_low, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 9. ìµœê·¼ Nì¼ í‰ê·  vs ì—­ëŒ€ ë™ì¼ ê¸°ê°„ í‰ê· 
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
st.subheader("ðŸ“… ìµœê·¼ ê¸°ê°„ í‰ê·  ê¸°ì˜¨ ë¶„ì„")

day_range = st.slider("ë¹„êµí•  ìµœê·¼ ì¼ ìˆ˜", 3, 30, 7)
start_day = pd.to_datetime(today) - pd.Timedelta(days=day_range)
recent_df = df[(df["ë‚ ì§œ"] >= start_day) & (df["ë‚ ì§œ"] < pd.to_datetime(today))]

avg_high = recent_df["ìµœê³ ê¸°ì˜¨(â„ƒ)"].mean()
avg_low  = recent_df["ìµœì €ê¸°ì˜¨(â„ƒ)"].mean()
avg_mean = recent_df["í‰ê· ê¸°ì˜¨(â„ƒ)"].mean()

# ë™ì¼ ê¸°ê°„(ê³¼ê±° ì—°ë„ë“¤ì˜ ê°™ì€ MM-DD) í‰ê· 
period_days = [(today - datetime.timedelta(days=i)).strftime("%m-%d") for i in range(1, day_range + 1)]
hist_df = df[df["ë‚ ì§œ"].dt.strftime("%m-%d").isin(period_days)]
hist_avg = (
    hist_df
    .groupby(hist_df["ë‚ ì§œ"].dt.strftime("%m-%d"))
    [["ìµœê³ ê¸°ì˜¨(â„ƒ)", "í‰ê· ê¸°ì˜¨(â„ƒ)", "ìµœì €ê¸°ì˜¨(â„ƒ)"]]
    .mean()
)
hist_high, hist_mean, hist_low = hist_avg.mean()

st.write(
    f"ðŸŒ¡ï¸ ìµœê·¼ {day_range}ì¼ í‰ê·  **{avg_high:.2f}/{avg_mean:.2f}/{avg_low:.2f}â„ƒ** "
    f"(ìµœê³ /í‰ê· /ìµœì €)\n"
    f"ðŸ—‚ï¸ ì—­ëŒ€ ë™ê¸°ê°„ í‰ê·  **{hist_high:.2f}/{hist_mean:.2f}/{hist_low:.2f}â„ƒ**"
)

# ë°±ë¶„ìœ„(í‰ê· ê¸°ì˜¨ ê¸°ì¤€)
pct = 100 * (hist_avg["í‰ê· ê¸°ì˜¨(â„ƒ)"] < avg_mean).sum() / len(hist_avg)
rank = len(hist_avg) - int(pct * len(hist_avg) / 100)
st.info(
    f"ðŸ“ˆ ìµœê·¼ {day_range}ì¼ í‰ê· ê¸°ì˜¨ì€ ì—­ëŒ€ ë™ì¼ ê¸°ê°„ ì¤‘ ìƒìœ„ **{100 - pct:.1f}%** "
    f"(ì „ì²´ {len(hist_avg)}ê°œ ê¸°ê°„ ì¤‘ {rank}ìœ„)ìž…ë‹ˆë‹¤."
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 10. ìµœê³  vs ìµœì € Scatter ë¶„í¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
st.subheader("ðŸ“ ìµœê³ ê¸°ì˜¨ vs ìµœì €ê¸°ì˜¨ ë¶„í¬")

scatter_df = same_day_df.copy()
scatter_df["ë‚ ì§œ(ë¬¸ìž)"] = scatter_df["ë‚ ì§œ"].dt.strftime("%Y-%m-%d")
scatter_df["ì–´ì œ"] = scatter_df["ë‚ ì§œ"] == yesterday_dt

fig_scatter = px.scatter(
    scatter_df, x="ìµœê³ ê¸°ì˜¨(â„ƒ)", y="ìµœì €ê¸°ì˜¨(â„ƒ)",
    color="ì–´ì œ", hover_name="ë‚ ì§œ(ë¬¸ìž)",
    title="ì—­ëŒ€ ìµœê³ Â·ìµœì € ê¸°ì˜¨ ë¶„í¬(ë™ì¼ ë‚ ì§œ)",
    labels={"ì–´ì œ": "ì–´ì œ ì—¬ë¶€"},
)
st.plotly_chart(fig_scatter, use_container_width=True)
